<%
  id ||= "checkboxes-#{SecureRandom.hex(4)}"
  classes ||= ''
  css_classes = %w( gem-c-checkboxes govuk-form-group )
  css_classes << classes if classes
  error ||= nil
  css_classes << "govuk-form-group--error" if error
  heading ||= nil
  hint_text ||= "Select all that apply."
  items ||= []
  is_page_heading ||= false

  # check if any item is set as being conditional
  has_conditional = items.any? { |item| item.is_a?(Hash) && item[:conditional] }
  has_nested = items.any? { |item| item.is_a?(Hash) && item[:items] }
%>

<%= tag.div id: id, class: css_classes, data: { module: "checkboxes" } do %>
  <%= tag.fieldset class: "govuk-fieldset", "aria-describedby": "#{id}-hint #{"#{id}-error" if error}" do %>

    <% if heading.present? %>
      <% if is_page_heading %>
        <%= tag.legend class: "govuk-fieldset__legend govuk-fieldset__legend--xl gem-c-title gem-c-title--margin-bottom-5" do %>
          <%= tag.h1 heading, class: "gem-c-title__text" %>
        <% end %>
      <% else %>
        <%= tag.legend heading, class: "govuk-fieldset__legend govuk-fieldset__legend--m" %>
      <% end %>
    <% end %>

    <%= tag.span hint_text, id: "#{id}-hint", class: "govuk-hint" %>

    <% if error.present? %>
      <%= tag.span error, id: "#{id}-error", class: "govuk-error-message" %>
    <% end %>

    <%= tag.div class: "govuk-checkboxes", data: {
      module: ('checkboxes' if has_conditional),
      nested: ('true' if has_nested),
    } do %>
      <% items.each_with_index do |item, index| %>
        <%= render 'govuk_publishing_components/components/checkbox', {
          id: id,
          name: name,
          item: item,
          index: index,
        } %>
        <% if item[:conditional] %>
          <%= tag.div item[:conditional], id: "#{id}-conditional-#{index}", class: "govuk-checkboxes__conditional govuk-checkboxes__conditional--hidden" %>
        <% end %>

        <% if item[:items].present? %>
          <%= tag.div id: "#{id}-nested-#{index}", class: "govuk-checkboxes govuk-checkboxes--nested", data: { parent: "#{id}-#{index}" } do %>
            <% item[:items].each_with_index do |nested_item, nested_index| %>
              <%= render 'govuk_publishing_components/components/checkbox', {
                id: id,
                name: name,
                item: nested_item,
                index: "#{index}-#{nested_index}",
              } %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>

  <% end %>
<% end %>
